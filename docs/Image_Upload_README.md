# X-Ray Image Upload Setup Guide

## Overview
The `upload_image.bat` script automates secure SFTP upload of intraoral X-ray images from dental imaging workstations to a remote Django-based media server. It uses SSH key-based authentication via PuTTY PSFTP and organizes images by producer/facility code.

## Purpose
- **Automated Transfer**: Eliminates manual file upload steps in the dental workflow
- **Secure Authentication**: Uses SSH keys instead of passwords for server access
- **Multi-Facility Support**: Routes images to appropriate subdirectories based on producer code
- **Audit Logging**: Tracks all upload attempts with timestamps for compliance

---

## Requirements

### Client-Side Requirements

#### 1. Software Dependencies
- **Windows OS**: Windows 10/11 or Windows Server
- **PuTTY Suite**: Required for SFTP client (PSFTP)
  - Install from: https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
  - Typical install path: `C:\Program Files\PuTTY\psftp.exe`
  - Alternative: `C:\Program Files (x86)\PuTTY\psftp.exe` (32-bit)
  - Verify inclusion in system path.

#### 2. SSH Keys (Client)
**Source Location**: `S:\Delph\Client_Fix_Files\`
**Destination Location**: `C:\Users\svc-dentappsnd-sftp\.ssh\`

**Required Files**:
- `id_rsa.ppk` - PuTTY private key (PuTTY format, **required**)
- `.ssh.pub` - Public key (for reference/backup)
- `.ssh` - OpenSSH private key (optional, for conversion)

**Key Format Note**: PSFTP requires **PuTTY .ppk format**. If you have an OpenSSH key:
1. Open **PuTTYgen** (included with PuTTY)
2. Load → Select your OpenSSH private key (`.ssh` or `id_rsa`)
3. Conversions → Export OpenSSH key → Save as `id_rsa.ppk`
4. Place the `.ppk` file in the `.ssh` directory

#### 3. Script Files
**Source Location**: `S:\Delph\Client_Fix_Files\`
**Destination Location**: `C:\Simlab\`

**Files**:
- `upload_image.bat` - Main upload script
- `xray.jpg` - Source image file (generated by imaging application)

---

## Server-Side Requirements

### 1. SSH Keys (Server)
**Location**: `/home/MARQNET/svc-dentappsnd-sftp/.ssh/`

**Required Files**:
- `authorized_keys` - Contains the public key from client's `.ssh.pub`

**Setup Commands** (run as root or with sudo):
```bash
# Create .ssh directory with correct permissions
mkdir -p /home/MARQNET/svc-dentappsnd-sftp/.ssh
chmod 700 /home/MARQNET/svc-dentappsnd-sftp/.ssh

# Add the public key (copy the entire line from client's .ssh.pub)
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC32gW..." >> /home/MARQNET/svc-dentappsnd-sftp/.ssh/authorized_keys

# Set correct permissions
chmod 600 /home/MARQNET/svc-dentappsnd-sftp/.ssh/authorized_keys
chown -R svc-dentappsnd-sftp:svc-dentappsnd-sftp /home/MARQNET/svc-dentappsnd-sftp/.ssh
```

### 2. Destination Directory Structure
**Base Path**: `/opt/dental/MusodDjango/media/xrays/`

**Structure**:
```
/opt/dental/MusodDjango/media/xrays/
├── S3894/
├── S3895/
├── S999A/
├── S999E/
└── [other producer codes]/
```

Each producer code (extracted from filename prefix) gets its own subdirectory.

### 3. Permissions & ACL Configuration

**Required ACL Commands** (run as root):
```bash
# Grant write access to svc-dentappsnd-sftp for all existing folders
sudo setfacl -R -m u:svc-dentappsnd-sftp:rwx /opt/dental/MusodDjango/media/xrays

# Set default ACL so new folders automatically inherit permissions
sudo setfacl -R -d -m u:svc-dentappsnd-sftp:rwx /opt/dental/MusodDjango/media/xrays
```

**Verify Permissions**:
```bash
getfacl /opt/dental/MusodDjango/media/xrays/S999E
```

**Expected Output**:
```
# file: opt/dental/MusodDjango/media/xrays/S999E
# owner: dental
# group: dental
user::rwx
user:svc-dentappsnd-sftp:rwx        ← Service account has write access
group::rwx
mask::rwx
other::r-x
default:user::rwx
default:user:svc-dentappsnd-sftp:rwx  ← New files inherit this
default:group::rwx
default:mask::rwx
default:other::r-x
```

---

## Usage

### Command Syntax
```batch
upload_image.bat "<path-to-ssh-directory>" "<remote-filename>"
```

### Example
```batch
upload_image.bat "C:\Users\svc-dentappsnd-sftp\.ssh" "S999E-2026-01-21.jpg"
```

### Parameters
- **Parameter 1**: Path to `.ssh` directory containing `id_rsa.ppk`
- **Parameter 2**: Target filename on server
  - Format: `{PRODUCER}-{DATE}.jpg`
  - Example: `S999E-2026-01-21.jpg`
  - Producer code (before first `-`) determines upload subfolder

### Expected Output (Success)
```
[INFO] Starting upload of xray.jpg as S999E-2026-01-21.jpg...
[INFO] Using key file: C:\Users\svc-dentappsnd-sftp\.ssh\id_rsa.ppk
Using username "svc-dentappsnd-sftp".
Remote working directory is /home/MARQNET/svc-dentappsnd-sftp
Remote directory is now /opt/dental/MusodDjango/media/xrays/S999E
[INFO] Upload succeeded: S999E-2026-01-21.jpg
```

---

## Troubleshooting

### Error: "Server refused our key"
**Cause**: Public key not in server's `authorized_keys` or wrong format.

**Fix**:
1. Verify public key is in `/home/MARQNET/svc-dentappsnd-sftp/.ssh/authorized_keys`
2. Check permissions (700 on `.ssh`, 600 on `authorized_keys`)
3. Ensure ownership is correct: `chown svc-dentappsnd-sftp:svc-dentappsnd-sftp`

### Error: "Unable to use key file... (OpenSSH SSH-2 private key)"
**Cause**: Key is in OpenSSH format, not PuTTY .ppk format.

**Fix**: Convert using PuTTYgen (see **Client-Side Requirements** section above)

### Error: "open for write: permission denied"
**Cause**: Service account lacks write permission on destination folder.

**Fix**: Run ACL commands on server (see **Permissions & ACL Configuration** section)

### Verification Command (Client)
Test authentication without upload:
```powershell
plink -v -i C:\Users\svc-dentappsnd-sftp\.ssh\id_rsa.ppk svc-dentappsnd-sftp@vs-dentappprod.marqnet.mu.edu exit
```
Should complete without password prompt if keys are configured correctly.

---

## Configuration Details

### Script Configuration (Hard-coded)
- **Local source file**: `xray.jpg` (in script's working directory)
- **SFTP user**: `svc-dentappsnd-sftp`
- **Remote host**: `vs-dentappprod.marqnet.mu.edu`
- **Remote base path**: `/opt/dental/MusodDjango/media/xrays/`
- **Log file**: `%TEMP%\upload_image.log`

### Logging
All upload attempts are logged to: `%TEMP%\upload_image.log` (typically `C:\Users\<username>\AppData\Local\Temp\`)

**Log Format**:
```
01/21/2026 15:08:18.78 Starting upload of xray.jpg as S999E-2026-01-21.jpg
01/21/2026 15:08:19.42 SUCCESS Upload succeeded: S999E-2026-01-21.jpg
```

---

## Security Considerations

### Best Practices
1. **Key Protection**: Keep `.ppk` files in restricted-access directories (e.g., service account home)
2. **No Password Storage**: This version uses SSH keys; no passwords in scripts
3. **Audit Logs**: Review `upload_image.log` regularly for unauthorized attempts
4. **Key Rotation**: Regenerate SSH keys periodically per security policy

### File Permissions
- **Client `.ppk` files**: Restrict to service account user only
- **Server `authorized_keys`**: Mode 600, owned by `svc-dentappsnd-sftp`
- **Destination folders**: Use ACLs to limit write access to service account

---

## Support & Maintenance

### Adding New Producer Folders
New producer folders created by Django will automatically inherit correct ACLs if default ACLs are set (see setup commands above). No manual configuration needed per folder.

### Log Rotation
Consider implementing log rotation for `%TEMP%\upload_image.log` to prevent unbounded growth.

### Integration Notes
This script is designed to be called by the SimLab X-Ray VCL2 application after image capture. Ensure the calling application:
- Places the image as `xray.jpg` in the script's directory
- Provides correct command-line arguments
- Handles script exit codes (0 = success, >0 = failure)

---

## Quick Reference

| Component | Location |
|-----------|----------|
| **Client Script** | `C:\Users\myersca\DelphProjects\simlab xray VCL2 2024\VCL2\upload_image.bat` |
| **Client Keys** | `C:\Users\svc-dentappsnd-sftp\.ssh\id_rsa.ppk` |
| **Server Keys** | `/home/MARQNET/svc-dentappsnd-sftp/.ssh/authorized_keys` |
| **Server Destination** | `/opt/dental/MusodDjango/media/xrays/{PRODUCER}/` |
| **Upload Logs** | `%TEMP%\upload_image.log` |
| **PuTTY PSFTP** | `C:\Program Files\PuTTY\psftp.exe` |

---

**Last Updated**: January 21, 2026  
**Script Version**: SSH Key Authentication (v2.0)
